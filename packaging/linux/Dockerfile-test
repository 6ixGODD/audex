# ============================================================================
# Audex DEB Package Test Environment
# ============================================================================
# This Dockerfile creates an environment to test the installed DEB package
# ============================================================================

FROM debian:bookworm

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# ============================================================================
# Layer 1: Base system packages
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
    vim \
    nano \
    curl \
    tree \
    less \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Layer 2: Build tools
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Layer 3: Python runtime
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-venv \
    python3-pip \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Layer 4: Audex dependencies
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pyqt6 \
    python3-pyqt6.qtwebengine \
    libfcitx5-qt6-1 \
    alsa-utils \
    sqlite3 \
    portaudio19-dev \
    ffmpeg \
    policykit-1 \
    network-manager \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Layer 5: Build arguments
# ============================================================================

ARG DEB_FILE
ARG GUIDE_SCRIPT

# ============================================================================
# Layer 6: Copy DEB package and guide script
# ============================================================================

COPY ${DEB_FILE} /tmp/audex.deb
COPY ${GUIDE_SCRIPT} /root/guide.sh

RUN chmod +x /root/guide.sh

# ============================================================================
# Layer 7: Setup environment
# ============================================================================

# Add guide alias for root
RUN echo "alias guide='/root/guide.sh'" >> /root/.bashrc && \
    echo "/root/guide.sh" >> /root/.bashrc

# Set working directory
WORKDIR /root

# ============================================================================
# Entry point
# ============================================================================

CMD ["/bin/bash"]
