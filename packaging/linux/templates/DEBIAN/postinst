#!/bin/bash
# ============================================================================
# Post-installation script for Audex DEB package
# ============================================================================

set -e

# ============================================================================
# Colors and Logging
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ“${NC} $1"; }
log_warn() { echo -e "${YELLOW}âš ${NC} $1"; }
log_error() { echo -e "${RED}âœ—${NC} $1"; }
log_step() { echo -e "\n${BLUE}â”â”â”${NC} $1"; }
print_separator() { echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; }

# ============================================================================
# Get Package Version
# ============================================================================

VERSION=$(dpkg -s audex 2>/dev/null | grep '^Version:' | awk '{print $2}')

echo ""
print_separator
echo -e "${BLUE}ğŸš€ Installing Audex ${VERSION}${NC}"
print_separator
echo ""

# ============================================================================
# Create System Directories
# ============================================================================

log_step "Creating system directories..."

mkdir -p /opt/audex
mkdir -p /etc/audex/templates

chmod 755 /opt/audex
chmod 755 /etc/audex
chmod 755 /etc/audex/templates

log_success "System directories created"

# ============================================================================
# Setup Python Virtual Environment
# ============================================================================

log_step "Setting up Python virtual environment..."

cd /opt/audex

# Create venv with system site packages (for PyQt6)
if [ ! -d "venv" ]; then
    python3 -m venv --system-site-packages venv
    log_success "Virtual environment created"
else
    log_info "Virtual environment already exists"
fi

# ============================================================================
# Install Audex from PyPI
# ============================================================================

log_step "Installing Audex ${VERSION} from PyPI..."
log_info "This may take a few minutes..."

venv/bin/pip install --quiet --upgrade pip
venv/bin/pip install --progress-bar on "audex==${VERSION}"

log_success "Audex ${VERSION} installed"

# ============================================================================
# Generate Configuration Templates (NOT actual config)
# ============================================================================

log_step "Generating configuration templates..."

# Generate system config template (for reference/setup wizard)
venv/bin/python3 -m audex init gencfg \
    --format system \
    --output /etc/audex/templates/config.system.yml \
    --platform linux

log_success "Generated: /etc/audex/templates/config.system.yml (template)"

# Generate example config (for reference)
venv/bin/python3 -m audex init gencfg \
    --format yaml \
    --output /etc/audex/templates/config.example.yml

log_success "Generated: /etc/audex/templates/config.example.yml (example)"

# ============================================================================
# Set Permissions
# ============================================================================

log_step "Setting permissions..."

chown -R root:root /opt/audex
chown -R root:root /etc/audex

chmod 755 /usr/bin/audex
chmod 755 /usr/bin/audex-setup

# Templates should be readable by all users
chmod 644 /etc/audex/templates/*

log_success "Permissions set"

# ============================================================================
# Configure systemd Service
# ============================================================================

log_step "Configuring systemd service..."

# Check if systemd is available
if command -v systemctl >/dev/null 2>&1 && systemctl is-system-running >/dev/null 2>&1; then
    systemctl daemon-reload
    log_success "Systemd service configured"
else
    log_warn "Systemd not available (running in container? ), skipping daemon-reload"
    log_info "Run 'systemctl daemon-reload' manually after installation"
fi

# ============================================================================
# Setup for existing users (optional, create directory structure)
# ============================================================================

log_step "Preparing user directory structure for existing users..."

# Function to setup user directory structure
setup_user_dirs() {
    local user_name=$1
    local user_home=$2

    if [ -d "$user_home" ] && [ "$user_name" != "root" ]; then
        log_info "Creating directory structure for: $user_name"

        # Create user directories (if they don't exist)
        sudo -u "$user_name" mkdir -p "$user_home/.config/audex" 2>/dev/null || true
        sudo -u "$user_name" mkdir -p "$user_home/.local/share/audex/store" 2>/dev/null || true
        sudo -u "$user_name" mkdir -p "$user_home/.local/share/audex/logs" 2>/dev/null || true

        # Set proper permissions
        chown -R "$user_name:$user_name" "$user_home/.config/audex" 2>/dev/null || true
        chown -R "$user_name:$user_name" "$user_home/.local/share/audex" 2>/dev/null || true

        log_success "Directory structure ready for $user_name"
    fi
}

# Setup for all existing normal users (UID >= 1000)
while IFS=: read -r user_name _ user_id _ _ user_home _; do
    if [ "$user_id" -ge 1000 ] && [ "$user_id" -lt 65534 ]; then
        setup_user_dirs "$user_name" "$user_home"
    fi
done < /etc/passwd

# ============================================================================
# Final Instructions
# ============================================================================

echo ""
print_separator
log_success "Audex ${VERSION} installed successfully!"
print_separator
echo ""
echo -e "${YELLOW}ğŸ“‹ Next Steps:${NC}"
echo ""
echo "  1ï¸âƒ£  Run the setup wizard (as your normal user):"
echo -e "     ${GREEN}audex-setup${NC}"
echo ""
echo "  2ï¸âƒ£  Start Audex manually:"
echo -e "     ${GREEN}audex${NC}"
echo ""
echo "  3ï¸âƒ£  Enable auto-start on boot (system-level):"
echo -e "     ${GREEN}sudo systemctl enable audex@\$USER.service${NC}"
echo -e "     ${GREEN}sudo systemctl start audex@\$USER.service${NC}"
echo ""
echo "  4ï¸âƒ£  Check service status:"
echo -e "     ${GREEN}systemctl status audex@\$USER.service${NC}"
echo ""
echo "  5ï¸âƒ£  View logs:"
echo -e "     ${GREEN}journalctl -u audex@\$USER.service -f${NC}"
echo -e "     ${GREEN}tail -f ~/.local/share/audex/logs/audex.log${NC}"
echo ""
print_separator
echo ""
echo -e "${BLUE}ğŸ“ User Directories (created per user):${NC}"
echo "   Configuration:  ~/.config/audex/config.yml"
echo "   Data:           ~/.local/share/audex/"
echo "   Logs:           ~/.local/share/audex/logs/"
echo ""
echo -e "${BLUE}ğŸ“ System Directories:${NC}"
echo "   Installation:   /opt/audex/"
echo "   Templates:      /etc/audex/templates/"
echo ""
echo -e "${YELLOW}âš ï¸  Important:${NC}"
echo "   - Audex runs as a normal user (no root required)"
echo "   - Each user needs to run 'audex-setup' once"
echo "   - Configuration templates are in /etc/audex/templates/"
echo "   - Actual config is in ~/.config/audex/config.yml"
echo ""
print_separator

exit 0
