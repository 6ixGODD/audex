#!/bin/bash
# ============================================================================
# Post-installation script for Audex DEB package
# ============================================================================

set -e

# ============================================================================
# Colors and Logging
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
log_success() { echo -e "${GREEN}‚úì${NC} $1"; }
log_warn() { echo -e "${YELLOW}‚ö†${NC} $1"; }
log_error() { echo -e "${RED}‚úó${NC} $1"; }
log_step() { echo -e "\n${BLUE}‚îÅ‚îÅ‚îÅ${NC} $1"; }
print_separator() { echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"; }

# ============================================================================
# Get Package Version
# ============================================================================

VERSION=$(dpkg -s audex 2>/dev/null | grep '^Version:' | awk '{print $2}')

echo ""
print_separator
echo -e "${BLUE}üöÄ Installing Audex ${VERSION}${NC}"
print_separator
echo ""

# ============================================================================
# Create System Directories
# ============================================================================

log_step "Creating system directories..."

mkdir -p /etc/audex
mkdir -p /var/lib/audex/store
mkdir -p /var/log/audex
mkdir -p /usr/lib/audex

chmod 755 /etc/audex
chmod 755 /var/lib/audex
chmod 755 /var/lib/audex/store
chmod 755 /var/log/audex
chmod 755 /usr/lib/audex

log_success "System directories created"

# ============================================================================
# Setup Python Virtual Environment
# ============================================================================

log_step "Setting up Python virtual environment..."

cd /usr/lib/audex

# Create venv with system site packages (for PyQt6)
if [ ! -d "venv" ]; then
    python3 -m venv --system-site-packages venv
    log_success "Virtual environment created"
else
    log_info "Virtual environment already exists"
fi

# ============================================================================
# Install Audex from PyPI
# ============================================================================

log_step "Installing Audex ${VERSION} from PyPI..."
log_info "This may take a few minutes..."

venv/bin/pip install --quiet --upgrade pip
venv/bin/pip install --progress-bar on "audex==${VERSION}"

log_success "Audex ${VERSION} installed"

# ============================================================================
# Generate System Configuration
# ============================================================================

log_step "Generating system configuration files..."

# Generate system config
venv/bin/python3 -m audex init gencfg \
    --format system \
    --output /etc/audex/config.system.yml \
    --platform linux

log_success "Generated: /etc/audex/config.system.yml"

# Generate example config
venv/bin/python3 -m audex init gencfg \
    --format yaml \
    --output /etc/audex/config.example.yml

log_success "Generated: /etc/audex/config.example.yml"

# ============================================================================
# Set Permissions
# ============================================================================

log_step "Setting permissions..."

chown -R root:root /usr/lib/audex
chown -R root:root /etc/audex
chown -R root:root /var/lib/audex
chown -R root:root /var/log/audex

chmod 755 /usr/bin/audex
chmod 755 /usr/bin/audex-setup

log_success "Permissions set"

# ============================================================================
# Configure systemd Service
# ============================================================================

log_step "Configuring systemd service..."

systemctl daemon-reload

log_success "Systemd service configured"

# ============================================================================
# Final Instructions
# ============================================================================

echo ""
print_separator
log_success "Audex ${VERSION} installed successfully!"
print_separator
echo ""
echo -e "${YELLOW}üìã Next Steps:${NC}"
echo ""
echo "  1Ô∏è‚É£  Run the setup wizard (required):"
echo -e "     ${GREEN}sudo audex-setup${NC}"
echo ""
echo "  2Ô∏è‚É£  Start Audex manually:"
echo -e "     ${GREEN}sudo audex${NC}"
echo ""
echo "  3Ô∏è‚É£  Enable auto-start on boot:"
echo -e "     ${GREEN}sudo systemctl enable audex.service${NC}"
echo -e "     ${GREEN}sudo systemctl start audex.service${NC}"
echo ""
echo "  4Ô∏è‚É£  Check service status:"
echo -e "     ${GREEN}sudo systemctl status audex.service${NC}"
echo ""
echo "  5Ô∏è‚É£  View logs:"
echo -e "     ${GREEN}sudo journalctl -u audex.service -f${NC}"
echo -e "     ${GREEN}sudo tail -f /var/log/audex/audex.log${NC}"
echo ""
print_separator
echo ""
echo -e "${BLUE}üìÅ System Directories:${NC}"
echo "   Configuration:  /etc/audex/"
echo "   Data:           /var/lib/audex/"
echo "   Logs:           /var/log/audex/"
echo "   Installation:   /usr/lib/audex/"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Important:${NC}"
echo "   - Audex requires root privileges to run"
echo "   - Always use 'sudo' when running audex commands"
echo "   - Configuration file: /etc/audex/config.yml (created by setup wizard)"
echo ""
print_separator

exit 0
