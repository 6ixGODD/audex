#!/bin/bash
# ============================================================================
# Audex Setup Wizard
# ============================================================================
# Description: Interactive configuration wizard (requires root privileges)
# ============================================================================

set -e

# ============================================================================
# Constants
# ============================================================================

readonly AUDEX_VENV="/usr/lib/audex/venv"
readonly SYSTEM_CONFIG_TEMPLATE="/etc/audex/config.system.yml"
readonly SYSTEM_CONFIG="/etc/audex/config.yml"
readonly EXAMPLE_CONFIG="/etc/audex/config.example.yml"

# ============================================================================
# Color Codes
# ============================================================================

readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# ============================================================================
# Root Permission Check
# ============================================================================

if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}‚ùå Error: Setup wizard requires root privileges${NC}"
    echo ""
    echo "Please run with sudo:"
    echo -e "  ${GREEN}sudo audex-setup${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Check Virtual Environment
# ============================================================================

if [ ! -f "$AUDEX_VENV/bin/activate" ]; then
    echo -e "${RED}‚ùå Error: Virtual environment not found at $AUDEX_VENV${NC}"
    echo ""
    echo "Please reinstall Audex:"
    echo -e "  ${GREEN}sudo apt install --reinstall audex${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Check System Configuration Template
# ============================================================================

if [ ! -f "$SYSTEM_CONFIG_TEMPLATE" ]; then
    echo -e "${RED}‚ùå Error: System configuration template not found${NC}"
    echo "   Expected: $SYSTEM_CONFIG_TEMPLATE"
    echo ""
    echo "Please reinstall Audex:"
    echo -e "  ${GREEN}sudo apt install --reinstall audex${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Ensure System Directories
# ============================================================================

mkdir -p /etc/audex
mkdir -p /var/lib/audex/store
mkdir -p /var/log/audex

# ============================================================================
# Setup Audio System
# ============================================================================

setup_audio_system() {
    echo -e "${BLUE}üîä Setting up audio system for root access...${NC}"

    mkdir -p /tmp/audex-audio
    chmod 777 /tmp/audex-audio

    if [ -d "/dev/snd" ]; then
        echo "   ‚úì ALSA devices detected"
        chmod 666 /dev/snd/* 2>/dev/null || true
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è  No ALSA devices found${NC}"
    fi

    if command -v pulseaudio >/dev/null 2>&1; then
        echo "   ‚úì PulseAudio available"

        mkdir -p /etc/pulse/system.pa.d
        cat > /etc/pulse/system.pa.d/audex.pa << 'EOF'
# Audex system audio configuration
# Allow root access to audio devices
load-module module-native-protocol-unix auth-anonymous=1 socket=/tmp/audex-pulse.sock
EOF
        echo "   ‚úì PulseAudio system configuration created"
    else
        echo -e "   ${YELLOW}‚ö†Ô∏è  PulseAudio not found, will use ALSA directly${NC}"
    fi

    if getent group audio >/dev/null; then
        usermod -a -G audio root 2>/dev/null || true
        echo "   ‚úì Root added to audio group"
    fi

    echo "   ‚úÖ Audio system setup completed"
    echo ""
}

# ============================================================================
# Audio Device Detection
# ============================================================================

detect_audio_devices() {
    echo -e "${BLUE}üé§ Detecting audio devices...${NC}"

    source "$AUDEX_VENV/bin/activate"

    python3 -c "
import pyaudio
import sys

try:
    pa = pyaudio.PyAudio()
    device_count = pa.get_device_count()

    input_devices = []
    for i in range(device_count):
        info = pa.get_device_info_by_index(i)
        if info['maxInputChannels'] > 0:
            input_devices.append((i, info['name'], info['maxInputChannels']))

    if input_devices:
        print('   ‚úì Available input devices:')
        for idx, name, channels in input_devices:
            print(f'     [{idx}] {name} ({channels} channels)')
        print(f'   ‚úì Total: {len(input_devices)} input device(s) found')
    else:
        print('   ‚ö†Ô∏è  No input devices found')

    pa.terminate()

except Exception as e:
    print(f'   ‚ùå Audio detection failed: {e}')
    sys.exit(1)
" 2>/dev/null || {
        echo -e "   ${RED}‚ùå Audio device detection failed${NC}"
        echo "   This may be resolved after completing the setup."
    }

    echo ""
}

# ============================================================================
# Launch Setup Wizard
# ============================================================================

echo ""
echo -e "${BLUE}üîß Audex Setup Wizard${NC}"
echo ""

# Setup audio system first
setup_audio_system

# Detect audio devices
detect_audio_devices

# Activate virtual environment
source "$AUDEX_VENV/bin/activate"

# Set audio environment for setup
export ALSA_PCM_CARD=0
export ALSA_PCM_DEVICE=0
export PULSE_RUNTIME_PATH="/tmp/audex-audio"
export PULSE_SERVER="unix:/tmp/audex-pulse.sock"
export PA_ALSA_PLUGHW=1

# Run setup wizard
python3 -m audex init setup \
    --config "$SYSTEM_CONFIG_TEMPLATE" \
    --output "$SYSTEM_CONFIG"

# Check if setup was successful
if [ $? -eq 0 ] && [ -f "$SYSTEM_CONFIG" ]; then
    echo ""
    echo -e "${GREEN}‚úÖ Configuration saved successfully!${NC}"
    echo ""
    echo -e "${BLUE}üìÅ Configuration file:${NC}"
    echo "   $SYSTEM_CONFIG"
    echo ""
    echo -e "${BLUE}üìã Next steps:${NC}"
    echo ""
    echo "  1Ô∏è‚É£  Start Audex:"
    echo -e "     ${GREEN}sudo audex${NC}"
    echo ""
    echo "  2Ô∏è‚É£  Enable auto-start:"
    echo -e "     ${GREEN}sudo systemctl enable audex.service${NC}"
    echo -e "     ${GREEN}sudo systemctl start audex.service${NC}"
    echo ""
    echo "  3Ô∏è‚É£  Check service status:"
    echo -e "     ${GREEN}sudo systemctl status audex.service${NC}"
    echo ""
    echo -e "${YELLOW}üí° Tips:${NC}"
    echo "   - Configuration can be edited at: $SYSTEM_CONFIG"
    echo "   - Example configuration: $EXAMPLE_CONFIG"
    echo "   - Re-run setup anytime with: sudo audex-setup"
    echo "   - Audio system configured for root access"
    echo ""
else
    echo ""
    echo -e "${RED}‚ùå Setup failed or was cancelled${NC}"
    echo ""
    echo "Please try again or check the logs for errors."
    echo ""
    exit 1
fi

exit 0
