#!/bin/bash
# ============================================================================
# Audex Setup Wizard
# ============================================================================
# Description: Interactive configuration wizard (runs as current user)
# ============================================================================

set -e

# ============================================================================
# Constants
# ============================================================================

readonly AUDEX_VENV="/opt/audex/venv"
readonly SYSTEM_CONFIG_TEMPLATE="/etc/audex/templates/config.system.yml"
readonly USER_CONFIG="$HOME/.config/audex/config.yml"
readonly EXAMPLE_CONFIG="/etc/audex/templates/config.example.yml"
readonly TEMP_CONFIG="/tmp/audex-config-$$.yml"

# ============================================================================
# Color Codes
# ============================================================================

readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# ============================================================================
# Cleanup on exit
# ============================================================================

cleanup() {
    rm -f "$TEMP_CONFIG"
}
trap cleanup EXIT

# ============================================================================
# Check Virtual Environment
# ============================================================================

if [ ! -f "$AUDEX_VENV/bin/activate" ]; then
    echo -e "${RED}‚ùå Error: Virtual environment not found at $AUDEX_VENV${NC}"
    echo ""
    echo "Please reinstall Audex:"
    echo -e "  ${GREEN}sudo apt install --reinstall audex${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Check System Configuration Template
# ============================================================================

if [ ! -f "$SYSTEM_CONFIG_TEMPLATE" ]; then
    echo -e "${RED}‚ùå Error: System configuration template not found${NC}"
    echo "   Expected: $SYSTEM_CONFIG_TEMPLATE"
    echo ""
    echo "Please reinstall Audex:"
    echo -e "  ${GREEN}sudo apt install --reinstall audex${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Ensure User Directories
# ============================================================================

mkdir -p "$HOME/.config/audex"
mkdir -p "$HOME/.local/share/audex/store"
mkdir -p "$HOME/.local/share/audex/logs"

# ============================================================================
# Expand Environment Variables in Template
# ============================================================================

expand_template() {
    local source_file=$1
    echo -e "${BLUE}üìù Preparing configuration... ${NC}"

    # Read template and expand environment variables
    # This supports ${VAR} syntax
    eval "cat <<EOF
$(cat "$source_file")
EOF
" > "$TEMP_CONFIG"

    echo -e "   ${GREEN}‚úì${NC} Environment variables expanded"
    echo ""
}

# ============================================================================
# Check Existing Configuration
# ============================================================================

check_existing_config() {
    if [ -f "$USER_CONFIG" ]; then
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  Existing configuration found! ${NC}"
        echo -e "${BLUE}üìÅ Location: ${NC}$USER_CONFIG"
        echo ""
        echo "What would you like to do?"
        echo ""
        echo "  ${GREEN}1)${NC} Edit existing configuration"
        echo "  ${GREEN}2)${NC} Create new configuration from template (overwrite)"
        echo "  ${GREEN}3)${NC} Cancel setup"
        echo ""

        while true; do
            read -p "Enter your choice [1-3]: " choice
            case $choice in
                1)
                    echo ""
                    echo -e "${BLUE}üìù Loading existing configuration...${NC}"
                    CONFIG_SOURCE="$USER_CONFIG"
                    break
                    ;;
                2)
                    echo ""
                    echo -e "${YELLOW}‚ö†Ô∏è  This will overwrite your existing configuration!${NC}"
                    read -p "Are you sure?  [y/N]: " confirm
                    if [[ $confirm =~ ^[Yy]$ ]]; then
                        echo ""
                        echo -e "${BLUE}üìù Using template configuration...${NC}"
                        CONFIG_SOURCE="$SYSTEM_CONFIG_TEMPLATE"
                        # Backup existing config
                        BACKUP_FILE="$USER_CONFIG.backup.$(date +%Y%m%d_%H%M%S)"
                        cp "$USER_CONFIG" "$BACKUP_FILE"
                        echo -e "   ${GREEN}‚úì${NC} Backup saved: $BACKUP_FILE"
                        break
                    else
                        echo ""
                        echo -e "${BLUE}Cancelled. Keeping existing configuration.${NC}"
                        continue
                    fi
                    ;;
                3)
                    echo ""
                    echo -e "${BLUE}Setup cancelled.${NC}"
                    echo ""
                    exit 0
                    ;;
                *)
                    echo -e "${RED}Invalid choice. Please enter 1, 2, or 3.${NC}"
                    ;;
            esac
        done
    else
        echo ""
        echo -e "${BLUE}üìù No existing configuration found.${NC}"
        echo -e "${BLUE}Creating new configuration from template...${NC}"
        CONFIG_SOURCE="$SYSTEM_CONFIG_TEMPLATE"
    fi
    echo ""
}

# ============================================================================
# Audio Device Detection
# ============================================================================

detect_audio_devices() {
    echo -e "${BLUE}üé§ Detecting audio devices...${NC}"

    source "$AUDEX_VENV/bin/activate"

    python3 -c "
import pyaudio
import sys

try:
    pa = pyaudio.PyAudio()
    device_count = pa.get_device_count()

    input_devices = []
    for i in range(device_count):
        info = pa.get_device_info_by_index(i)
        if info['maxInputChannels'] > 0:
            input_devices.append((i, info['name'], info['maxInputChannels']))

    if input_devices:
        print('   ‚úì Available input devices:')
        for idx, name, channels in input_devices:
            print(f'     [{idx}] {name} ({channels} channels)')
        print(f'   ‚úì Total: {len(input_devices)} input device(s) found')
    else:
        print('   ‚ö†Ô∏è  No input devices found')

    pa.terminate()

except Exception as e:
    print(f'   ‚ùå Audio detection failed: {e}')
    sys.exit(1)
" 2>/dev/null || {
        echo -e "   ${YELLOW}‚ö†Ô∏è  Audio device detection failed${NC}"
        echo "   This may be resolved after completing the setup."
    }

    echo ""
}

# ============================================================================
# Launch Setup Wizard
# ============================================================================

echo ""
echo -e "${BLUE}üîß Audex Setup Wizard${NC}"
echo -e "${BLUE}Running as user: ${GREEN}$(whoami)${NC}"
echo -e "${BLUE}Config location: ${GREEN}$USER_CONFIG${NC}"

# Check for existing configuration and get user choice
check_existing_config

# Expand environment variables in the chosen source
expand_template "$CONFIG_SOURCE"

# Detect audio devices
detect_audio_devices

# Activate virtual environment
source "$AUDEX_VENV/bin/activate"

# Run setup wizard (use expanded config)
python3 -m audex init setup \
    --config "$TEMP_CONFIG" \
    --output "$USER_CONFIG"

# Check if setup was successful
if [ $? -eq 0 ] && [ -f "$USER_CONFIG" ]; then
    echo ""
    echo -e "${GREEN}‚úÖ Configuration saved successfully!${NC}"
    echo ""
    echo -e "${BLUE}üìÅ Your configuration file:${NC}"
    echo "   $USER_CONFIG"
    echo ""
    echo -e "${BLUE}üìã Next steps:${NC}"
    echo ""
    echo "  1Ô∏è‚É£  Start Audex:"
    echo -e "     ${GREEN}audex${NC}"
    echo ""
    echo "  2Ô∏è‚É£  Enable auto-start (system-level):"
    echo -e "     ${GREEN}sudo systemctl enable audex@\$(whoami).service${NC}"
    echo -e "     ${GREEN}sudo systemctl start audex@\$(whoami).service${NC}"
    echo ""
    echo "  3Ô∏è‚É£  Check service status:"
    echo -e "     ${GREEN}systemctl status audex@\$(whoami).service${NC}"
    echo ""
    echo "  4Ô∏è‚É£  View logs:"
    echo -e "     ${GREEN}tail -f ~/.local/share/audex/logs/audex.log${NC}"
    echo ""
    echo -e "${YELLOW}üí° Tips:${NC}"
    echo "   - Your config: $USER_CONFIG"
    echo "   - Example config: $EXAMPLE_CONFIG"
    echo "   - Re-run setup anytime: audex-setup"
    echo "   - Audex runs as your user (no root)"
    echo ""
else
    echo ""
    echo -e "${RED}‚ùå Setup failed or was cancelled${NC}"
    echo ""
    echo "Please try again or check the logs for errors."
    echo ""
    exit 1
fi

exit 0
