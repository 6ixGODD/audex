#!/bin/bash
# Audex Configuration Wizard
# This script helps users configure API credentials

set -e

# Colors
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'

# Paths
readonly USER_CONFIG="$HOME/.config/audex/config.yml"
readonly EXAMPLE_CONFIG="/etc/audex/config.example.yml"
readonly SYSTEM_CONFIG="/etc/audex/config.system.yml"
readonly USER_DATA="$HOME/.local/share/audex"

# Logging functions
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Display welcome message
show_welcome() {
    clear
    echo -e "${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                â•‘"
    echo "â•‘         Audex Configuration Wizard             â•‘"
    echo "â•‘                                                â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
    log_info "This wizard will help you configure Audex with your API credentials."
    echo ""
}

# Prompt for input with validation
prompt_input() {
    local prompt="$1"
    local var_name="$2"
    local required="$3"
    local secret="$4"
    local value=""

    while true; do
        if [ "$secret" = "true" ]; then
            read -sp "$prompt: " value
            echo ""
        else
            read -p "$prompt: " value
        fi

        if [ "$required" = "true" ] && [ -z "$value" ]; then
            log_error "This field is required. Please try again."
            continue
        fi

        eval "$var_name='$value'"
        break
    done
}

# Choose transcription provider
choose_transcription_provider() {
    echo ""
    log_info "Select Transcription Provider:"
    echo "  1) Dashscope (Alibaba Cloud)"
    echo ""

    local choice
    read -p "Enter choice [1]: " choice
    choice=${choice:-1}

    case $choice in
        1)
            TRANSCRIPTION_PROVIDER="dashscope"
            log_success "Selected: Dashscope"
            echo ""
            log_info "Configuring Dashscope credentials..."
            prompt_input "Dashscope API Key" DASHSCOPE_API_KEY true true
            ;;
        *)
            log_error "Invalid choice. Defaulting to Dashscope."
            TRANSCRIPTION_PROVIDER="dashscope"
            prompt_input "Dashscope API Key" DASHSCOPE_API_KEY true true
            ;;
    esac
}

# Choose VPR provider
choose_vpr_provider() {
    echo ""
    log_info "Select VPR (Voice Print Recognition) Provider:"
    echo "  1) XFYun (iFlytek)"
    echo "  2) Unisound"
    echo ""

    local choice
    read -p "Enter choice [1]: " choice
    choice=${choice:-1}

    case $choice in
        1)
            VPR_PROVIDER="xfyun"
            log_success "Selected: XFYun"
            echo ""
            log_info "Configuring XFYun credentials..."
            prompt_input "XFYun App ID" XFYUN_APP_ID true false
            prompt_input "XFYun API Key" XFYUN_API_KEY true true
            prompt_input "XFYun API Secret" XFYUN_API_SECRET true true
            ;;
        2)
            VPR_PROVIDER="unisound"
            log_success "Selected: Unisound"
            echo ""
            log_info "Configuring Unisound credentials..."
            prompt_input "Unisound AppKey" UNISOUND_APPKEY true false
            prompt_input "Unisound Secret" UNISOUND_SECRET true true
            ;;
        *)
            log_error "Invalid choice. Defaulting to XFYun."
            VPR_PROVIDER="xfyun"
            prompt_input "XFYun App ID" XFYUN_APP_ID true false
            prompt_input "XFYun API Key" XFYUN_API_KEY true true
            prompt_input "XFYun API Secret" XFYUN_API_SECRET true true
            ;;
    esac
}

# Generate user configuration file
generate_config() {
    log_info "Generating configuration file..."

    # Create config directory if not exists
    mkdir -p "$(dirname "$USER_CONFIG")"
    mkdir -p "$USER_DATA"/{store,logs}

    # Copy example config as base
    if [ -f "$EXAMPLE_CONFIG" ]; then
        cp "$EXAMPLE_CONFIG" "$USER_CONFIG"
    else
        log_error "Example configuration not found: $EXAMPLE_CONFIG"
        exit 1
    fi

    # Replace paths
    sed -i "s|logs\\\\audex.jsonl|$USER_DATA/logs/audex.jsonl|g" "$USER_CONFIG"
    sed -i "s|\\./audex\\.db|$USER_DATA/audex.db|g" "$USER_CONFIG"
    sed -i "s|\\./store|$USER_DATA/store|g" "$USER_CONFIG"
    sed -i "s|\\.xf\\.vprgroup|$USER_DATA/.xf.vprgroup|g" "$USER_CONFIG"
    sed -i "s|\\.unisound\\.vprgroup|$USER_DATA/.unisound.vprgroup|g" "$USER_CONFIG"

    # Set native mode to true for Linux
    sed -i "s|native: false|native: true|g" "$USER_CONFIG"

    # Update transcription provider credentials
    if [ "$TRANSCRIPTION_PROVIDER" = "dashscope" ]; then
        sed -i "s|api_key: <UNSET>|api_key: \"$DASHSCOPE_API_KEY\"|" "$USER_CONFIG"
    fi

    # Update VPR provider
    sed -i "s|provider: xfyun|provider: $VPR_PROVIDER|" "$USER_CONFIG"

    if [ "$VPR_PROVIDER" = "xfyun" ]; then
        # Update XFYun credentials
        sed -i "/xfyun:/,/http:/ {
            s|app_id: <UNSET>|app_id: \"$XFYUN_APP_ID\"|
            s|api_key: <UNSET>|api_key: \"$XFYUN_API_KEY\"|
            s|api_secret: <UNSET>|api_secret: \"$XFYUN_API_SECRET\"|
        }" "$USER_CONFIG"
    elif [ "$VPR_PROVIDER" = "unisound" ]; then
        # Update Unisound credentials
        sed -i "/unisound:/,/http:/ {
            s|appkey: <UNSET>|appkey: \"$UNISOUND_APPKEY\"|
            s|secret: <UNSET>|secret: \"$UNISOUND_SECRET\"|
        }" "$USER_CONFIG"
    fi

    # Set proper permissions (user read/write only for security)
    chmod 600 "$USER_CONFIG"

    log_success "Configuration saved to: $USER_CONFIG"
}

# Initialize VPR Group
init_vpr_group() {
    log_info "Initializing VPR Group..."

    # Activate venv
    if [ -f "/usr/lib/audex/venv/bin/activate" ]; then
        source ./usr/lib/audex/venv/bin/activate

        # Run VPR group initialization
        if python3 -m audex init vprgroup --config "$USER_CONFIG" 2>&1 | tee /tmp/audex-vprgroup-init.log; then
            log_success "VPR Group initialized successfully"
        else
            log_warning "VPR Group initialization failed or was skipped"
            log_info "You can manually initialize later with:"
            echo "  python3 -m audex init vprgroup --config ~/.config/audex/config.yml"
        fi

        deactivate
    else
        log_error "Virtual environment not found"
        log_info "Please run manually after installation:"
        echo "  python3 -m audex init vprgroup --config ~/.config/audex/config.yml"
    fi
}

# Display summary
show_summary() {
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘           Configuration Complete!               â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    log_info "Configuration Summary:"
    echo "  ğŸ“ Config file: $USER_CONFIG"
    echo "  ğŸ“ Data directory: $USER_DATA"
    echo "  ğŸ™ï¸  Transcription: $TRANSCRIPTION_PROVIDER"
    echo "  ğŸ‘¤ VPR: $VPR_PROVIDER"
    echo ""
    log_success "You can now run Audex with: audex"
    echo ""
    log_info "To modify configuration manually:"
    echo "  Edit: $USER_CONFIG"
    echo "  Reference: $EXAMPLE_CONFIG"
    echo ""
    log_info "To reconfigure, run: audex-setup"
    echo ""
}

# Main execution
main() {
    # Check if already configured
    if [ -f "$USER_CONFIG" ]; then
        log_warning "Configuration file already exists: $USER_CONFIG"
        read -p "Do you want to reconfigure? (y/N): " reconfigure
        if [ "$reconfigure" != "y" ] && [ "$reconfigure" != "Y" ]; then
            log_info "Configuration unchanged.Exiting."
            exit 0
        fi
        # Backup existing config
        cp "$USER_CONFIG" "$USER_CONFIG.backup.$(date +%Y%m%d_%H%M%S)"
        log_info "Backed up existing configuration."
    fi

    show_welcome
    choose_transcription_provider
    choose_vpr_provider
    generate_config
    init_vpr_group
    show_summary
}

main "$@"
