#!/bin/bash
# ============================================================================
# Audex Setup Wizard
# ============================================================================
# Description: Interactive configuration wizard (requires root privileges)
# ============================================================================

set -e

# ============================================================================
# Constants
# ============================================================================

readonly AUDEX_VENV="/usr/lib/audex/venv"
readonly SYSTEM_CONFIG_TEMPLATE="/etc/audex/config.system.yml"
readonly SYSTEM_CONFIG="/etc/audex/config.yml"
readonly EXAMPLE_CONFIG="/etc/audex/config.example.yml"

# ============================================================================
# Color Codes
# ============================================================================

readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# ============================================================================
# Root Permission Check
# ============================================================================

if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}‚ùå Error: Setup wizard requires root privileges${NC}"
    echo ""
    echo "Please run with sudo:"
    echo -e "  ${GREEN}sudo audex-setup${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Check Virtual Environment
# ============================================================================

if [ ! -f "$AUDEX_VENV/bin/activate" ]; then
    echo -e "${RED}‚ùå Error: Virtual environment not found at $AUDEX_VENV${NC}"
    echo ""
    echo "Please reinstall Audex:"
    echo -e "  ${GREEN}sudo apt install --reinstall audex${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Check System Configuration Template
# ============================================================================

if [ ! -f "$SYSTEM_CONFIG_TEMPLATE" ]; then
    echo -e "${RED}‚ùå Error: System configuration template not found${NC}"
    echo "   Expected: $SYSTEM_CONFIG_TEMPLATE"
    echo ""
    echo "Please reinstall Audex:"
    echo -e "  ${GREEN}sudo apt install --reinstall audex${NC}"
    echo ""
    exit 1
fi

# ============================================================================
# Ensure System Directories
# ============================================================================

mkdir -p /etc/audex
mkdir -p /var/lib/audex/store
mkdir -p /var/log/audex

# ============================================================================
# Launch Setup Wizard
# ============================================================================

echo ""
echo -e "${BLUE}üîß Audex Setup Wizard${NC}"
echo ""

# Activate virtual environment
source "$AUDEX_VENV/bin/activate"

# Run setup wizard
python3 -m audex init setup \
    --config "$SYSTEM_CONFIG_TEMPLATE" \
    --output "$SYSTEM_CONFIG"

# Check if setup was successful
if [ $? -eq 0 ] && [ -f "$SYSTEM_CONFIG" ]; then
    echo ""
    echo -e "${GREEN}‚úÖ Configuration saved successfully!${NC}"
    echo ""
    echo -e "${BLUE}üìÅ Configuration file:${NC}"
    echo "   $SYSTEM_CONFIG"
    echo ""
    echo -e "${BLUE}üìã Next steps:${NC}"
    echo ""
    echo "  1Ô∏è‚É£  Start Audex:"
    echo -e "     ${GREEN}sudo audex${NC}"
    echo ""
    echo "  2Ô∏è‚É£  Enable auto-start:"
    echo -e "     ${GREEN}sudo systemctl enable audex.service${NC}"
    echo -e "     ${GREEN}sudo systemctl start audex.service${NC}"
    echo ""
    echo "  3Ô∏è‚É£  Check service status:"
    echo -e "     ${GREEN}sudo systemctl status audex.service${NC}"
    echo ""
    echo -e "${YELLOW}üí° Tips:${NC}"
    echo "   - Configuration can be edited at: $SYSTEM_CONFIG"
    echo "   - Example configuration: $EXAMPLE_CONFIG"
    echo "   - Re-run setup anytime with: sudo audex-setup"
    echo ""
else
    echo ""
    echo -e "${RED}‚ùå Setup failed or was cancelled${NC}"
    echo ""
    echo "Please try again or check the logs for errors."
    echo ""
    exit 1
fi

exit 0
