# ============================================================================
# Audex DEB Package Build Environment
# ============================================================================
# This Dockerfile creates a clean Debian environment to build DEB packages
# ============================================================================

FROM debian:bookworm

# ============================================================================
# Prevent interactive prompts
# ============================================================================

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# ============================================================================
# Update package lists with retries
# ============================================================================

RUN apt-get update || (sleep 5 && apt-get update) || (sleep 10 && apt-get update)

# ============================================================================
# Install Python and build tools
# ============================================================================

RUN apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv

# ============================================================================
# Install dpkg-dev and build-essential for building DEB packages
# ============================================================================

RUN apt-get install -y --no-install-recommends \
    dpkg-dev \
    build-essential

# ============================================================================
# Clean up apt cache
# ============================================================================

RUN rm -rf /var/lib/apt/lists/*

# ============================================================================
# Set working directory
# ============================================================================

WORKDIR /build

# ============================================================================
# Copy templates
# ============================================================================

COPY templates /build/templates

# ============================================================================
# Copy build script
# ============================================================================

COPY build.py /build/build.py

# ============================================================================
# Set entrypoint
# ============================================================================

ENTRYPOINT ["python3", "/build/build.py"]
